---
title: "football"
output: pdf_document
date: "2023-03-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Import Libraries
library(dplyr)
library(tidyr)
library(tidyverse)
```
```{r}
# Code
data_df = read_csv('data/cleaned_match_data.csv')

# Removed date because it doesnt add any value to data
data_df = data_df[-c(1)]

# Convert Datatype
data_df$HTR = as.factor(data_df$HTR)
data_df$FTR = as.factor(data_df$FTR)
data_df$HomeTeam = as.factor(data_df$HomeTeam)
data_df$AwayTeam = as.factor(data_df$AwayTeam)
str(data_df)
```

```{r}
numeric_col = unlist(lapply(data_df, is.numeric))

cat("Numerical Columns within dataset: ", colnames(data_df[, numeric_col]),"\n")

cat("Categorical Columns within dataset: ", colnames(data_df[, !numeric_col]))

data_df[,numeric_col] = sapply(data_df[,numeric_col],as.integer)
```

```{r fig.height=6, fig.width=10, warning=FALSE}
# Distributions Analysis
gg <- 
  ggplot(gather(data_df[,!numeric_col], cols, value), aes(x = value)) + 
       geom_histogram(stat="count") + facet_wrap(.~cols, scales="free", nrow=2)

ggsave(
  file.path("images", "cat_distribution.png"),
  plot = gg,
  width = 12, 
  height = 8, 
  units = "in",
  dpi = 200
)

gg

gg <- 
  ggplot(gather(data_df[, numeric_col], cols, value), aes(x = value)) + 
  geom_histogram() +
  facet_wrap(.~cols, scales="free", nrow=5)

ggsave(
  file.path("images", "num_distribution.png"),
  plot = gg,
  width = 12, 
  height = 8, 
  units = "in",
  dpi = 200
)

gg
```
```{r fig.height=14, fig.width=14, warning=FALSE}
# Correlation Plots
upper_panel<-function(x, y){
    points(x,y, pch=19, col=c("darkblue", "darkorange", "violet")[data_df$FTR])
}

lower_panel <- function(x, y){
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- round(cor(x, y), digits=2)
    txt <- paste0("R = ", r)
    text(0.5, 0.5, txt)
}

num_data = data_df[,numeric_col]
num_data = cbind(num_data, FTR=data_df$FTR)

# pairs(num_hdp_data[c(1:6)],
#       upper.panel = upper_panel,
#       lower.panel = lower_panel
#       )
# pairs(num_hdp_data[c(7:12)],
#       upper.panel = upper_panel,
#       lower.panel = lower_panel
#       )
# pairs(num_hdp_data[c(13:18)],
#       upper.panel = upper_panel,
#       lower.panel = lower_panel
#       )
# pairs(num_hdp_data[c(19:21)],
#       upper.panel = upper_panel,
#       lower.panel = lower_panel
#       )

gg <- pairs(num_data,
      upper.panel = upper_panel,
      lower.panel = lower_panel)

ggsave(
  file.path("images", "correlation.png"),
  plot = gg,
  width = 14, 
  height = 14, 
  units = "in",
  dpi = 200
)

gg
```

```{r}
home_team_wins <- as.data.frame(table(filter(data_df, FTR=="H")$HomeTeam))
away_team_wins <- as.data.frame(table(filter(data_df, FTR=="A")$AwayTeam))
team_wins <- cbind(home_team_wins,away_team_wins$Freq)
draw_team_wins <- filter(data_df, FTR=="D")[c("HomeTeam", "AwayTeam")]
colnames(team_wins) <- c("TeamName", "HomeWins", "AwayWins")

team_wins$HomeDraw = as.data.frame(table(draw_team_wins$HomeTeam))$Freq
team_wins$AwayDraw = as.data.frame(table(draw_team_wins$AwayTeam))$Freq


team_wins$HomeLoss <- as.data.frame(table(data_df$HomeTeam))$Freq - team_wins$HomeWins - team_wins$HomeDraw
team_wins$AwayLoss <- as.data.frame(table(data_df$AwayTeam))$Freq - team_wins$AwayWins - team_wins$AwayDraw
```

```{r fig.height=14, fig.width=14}
team_wins_plot <- melt(team_wins, id.vars = 1)
team_wins_plot$Ground <- substr(team_wins_plot$variable, 1, 4)
team_wins_plot$variable <- substr(team_wins_plot$variable, 5, 8)

ggplot(team_wins_plot, aes(fill=variable, y=value, x=Ground)) + 
    geom_bar(position="fill", stat="identity")+
  facet_wrap(vars(team_wins_plot$TeamName),  scales = "free_x")

team_wins$Home_Strength <- ((team_wins$HomeWins*3+team_wins$HomeDraw*1) / ((team_wins$HomeWins+team_wins$HomeLoss+team_wins$HomeDraw)*3))*100

team_wins$Away_Strength <- ((team_wins$AwayWins*3+team_wins$AwayDraw*1) / ((team_wins$AwayWins+team_wins$AwayLoss+team_wins$AwayDraw)*3))*100
```

```{r}
hist(team_wins$Home_Strength)
hist(team_wins$Away_Strength)
```

```{r}
# Remove variables based on correlation and domain
final_df <- data_df[,!(names(data_df) %in% c("FTHG","FTAG", "HS", "AS", "HTR"))]
final_df2 <- inner_join(final_df, team_wins[c("TeamName","Home_Strength")], join_by(HomeTeam==TeamName))
final_df2 <- inner_join(final_df2, team_wins[c("TeamName","Away_Strength")], join_by(AwayTeam==TeamName))
str(final_df)
```
```{r}
final_df <- final_df2[-c(1,2)]
```

```{r}
ggplot(aes(y=reorder(TeamName, Home_Strength), x=Home_Strength,
       fill=Home_Strength),
       data=team_wins[order(team_wins$Home_Strength, decreasing=TRUE)[1:10],])+
  geom_bar(stat="identity")+
  scale_fill_gradient(low = "cyan", high = "blue")+
  ylab("Team")
```
```{r}
ggplot(aes(y=reorder(TeamName, Away_Strength), x=Away_Strength,
       fill=Away_Strength),
       data=team_wins[order(team_wins$Away_Strength, decreasing=TRUE)[1:10],])+
  geom_bar(stat="identity")+
  scale_fill_gradient(low = "violet", high = "darkblue")+
  ylab("Team")
```
